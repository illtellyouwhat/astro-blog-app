---
import BaseLayout from "~/layouts/BaseLayout.astro";
import { getCollection } from "astro:content";
import type { CollectionEntry } from "astro:content";
import { site } from "@/consts";
import UtterancesComments from "~/components/UtterancesComments.astro";

export const getStaticPaths = async () => {
  const posts = await getCollection("posts", ({ data }) => !data.draft);
  return posts.map((post) => ({
    params: { slug: post.slug },
    props: { post }
  }));
};

const { post } = Astro.props as { post: CollectionEntry<"posts"> };
const { Content, headings } = await post.render();

const description = post.data.excerpt ?? "Read the latest update from Automation Architech.";
const publicationDate = post.data.date.toLocaleDateString(undefined, {
  year: "numeric",
  month: "long",
  day: "numeric"
});
const formattedDateForAside = post.data.date.toLocaleDateString(undefined, {
  year: "numeric",
  month: "short",
  day: "numeric"
});

const headingIndent = (depth: number) => {
  if (depth <= 2) return "";
  if (depth === 3) return "pl-4";
  if (depth === 4) return "pl-8";
  return "pl-10";
};

const articleJsonLd: Record<string, unknown> = {
  "@context": "https://schema.org",
  "@type": "Article",
  headline: post.data.title,
  description,
  datePublished: post.data.date.toISOString(),
  dateModified: post.data.date.toISOString(),
  mainEntityOfPage: {
    "@type": "WebPage",
    "@id": `${site.url}/blog/${post.slug}/`
  },
  author: {
    "@type": "Organization",
    name: site.title,
    url: site.url
  },
  publisher: {
    "@type": "Organization",
    name: site.title,
    logo: {
      "@type": "ImageObject",
      url: `${site.url}${site.favicon}`
    }
  }
};

if (post.data.hero) {
  articleJsonLd.image = `${site.url}${post.data.hero}`;
}

const commentsEnabled =
  (post.data.comments ?? true) &&
  import.meta.env.PUBLIC_ENABLE_COMMENTS !== "false" &&
  Boolean(import.meta.env.PUBLIC_UTTERANCES_REPO);

const issueTerm = `${site.baseUrl}/blog/${post.slug}/`.replace(/\/\/+/g, "/");
---
<BaseLayout
  title={post.data.title}
  description={description}
  publishedAt={post.data.date}
  hero={post.data.hero}
  seoType="article"
  jsonLd={articleJsonLd}
>
  <article class="space-y-8">
    <header class="space-y-4">
      <h1 class="text-4xl font-semibold tracking-tight text-skin-base">{post.data.title}</h1>
      <div class="flex flex-wrap items-center gap-3 text-sm text-skin-dodge">
        <time datetime={post.data.date.toISOString()}>{publicationDate}</time>
        {post.data.tags.length > 0 && (
          <ul class="flex flex-wrap items-center gap-2">
            {post.data.tags.map((tag) => (
              <li class="rounded-full border border-skin-base/40 bg-skin-fill px-3 py-1 text-xs font-medium text-skin-dodge">
                #{tag}
              </li>
            ))}
          </ul>
        )}
      </div>
    </header>

    <div class="markdown-body prose prose-slate max-w-none">
      <Content />
    </div>
  </article>

  {commentsEnabled && <UtterancesComments issueTerm={issueTerm} />}

  <div slot="aside" class="space-y-6">
    <div class="rounded-xl border border-skin-base/20 bg-skin-card p-5 shadow-card">
      <h2 class="text-sm font-semibold uppercase tracking-wide text-skin-dodge">Article details</h2>
      <dl class="mt-3 space-y-2 text-sm">
        <div class="flex justify-between gap-3">
          <dt class="text-skin-dodge">Published</dt>
          <dd>{formattedDateForAside}</dd>
        </div>
        {post.data.tags.length > 0 && (
          <div>
            <dt class="text-skin-dodge">Topics</dt>
            <dd class="mt-1 flex flex-wrap gap-2">
              {post.data.tags.map((tag) => (
                <span class="rounded-full border border-skin-base/40 bg-skin-fill px-3 py-1 text-xs font-medium text-skin-dodge">
                  {tag}
                </span>
              ))}
            </dd>
          </div>
        )}
      </dl>
    </div>
    {headings.length > 0 && (
      <nav class="rounded-xl border border-skin-base/20 bg-skin-card p-5 shadow-card">
        <h2 class="text-sm font-semibold uppercase tracking-wide text-skin-dodge">On this page</h2>
        <ol class="mt-3 space-y-2 text-sm">
          {headings.map((heading) => {
            const indentClass = headingIndent(heading.depth);
            return (
              <li class={`${indentClass} text-skin-dodge`}>
                <a class="hover:text-skin-active" href={`#${heading.slug}`}>{heading.text}</a>
              </li>
            );
          })}
        </ol>
      </nav>
    )}
  </div>
</BaseLayout>
